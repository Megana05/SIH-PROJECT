<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USSD Simulator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%);
      font-family: 'Segoe UI', monospace, Arial;
    }
    .phone {
      width: 320px;
      height: 540px;
      background: #222;
      border-radius: 24px;
      padding: 18px;
      color: #0f0;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(44, 62, 80, 0.18);
      animation: fadeIn 0.7s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .screen {
      background: #111;
      flex: 1;
      margin-bottom: 15px;
      padding: 14px;
      border-radius: 12px;
      overflow-y: auto;
      white-space: pre-line;
      font-size: 1.08em;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
    }
    input, button {
      padding: 12px;
      border-radius: 8px;
      margin-top: 7px;
      font-size: 1em;
      border: none;
      outline: none;
    }
    input {
      background: #333;
      color: #0f0;
      border: 1px solid #444;
      width: 100%;
    }
    button {
      background: linear-gradient(90deg, #4CAF50 60%, #2196F3 100%);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
      transition: background 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg, #2196F3 60%, #4CAF50 100%);
    }
    .phone-header {
      text-align: center;
      color: #fff;
      margin-bottom: 10px;
      font-size: 1.2em;
      letter-spacing: 1px;
    }
    .phone-header i { margin-right: 8px; }
    @media (max-width: 500px) {
      .phone { width: 98vw; height: 98vw; padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="phone">
    <div class="phone-header"><i class="fa-solid fa-mobile-screen-button"></i> USSD Simulator</div>
    <div class="screen" id="screen">Dial *123# to begin...</div>
    <input type="text" id="input" placeholder="Enter choice">
    <button onclick="sendInput()"><i class="fa-solid fa-paper-plane"></i> Send</button>
  </div>
  <script>
    // ...existing code...
    let step = 0;
    let language = "en";
    const screen = document.getElementById("screen");

    const stops = {
      "en": {
        "1": { name: "High Court", lat: 13.08698, lon: 80.28763 },
        "2": { name: "MGR Central Station / Govt. General Hospital", lat: 13.0800, lon: 80.2767 },
        "3": { name: "Park Station", lat: 13.0805, lon: 80.2790 },
        "4": { name: "Hotel Everest", lat: 13.0810, lon: 80.2785 },
        "5": { name: "Thinathanthi", lat: 13.0820, lon: 80.2775 },
        "6": { name: "Dasaprakash", lat: 13.0830, lon: 80.2765 },
        "7": { name: "Sangam Theatre", lat: 13.0840, lon: 80.2750 },
        "8": { name: "KMC Hospital", lat: 13.0850, lon: 80.2740 },
        "9": { name: "Taylors Road", lat: 13.0860, lon: 80.2730 },
        "10": { name: "Pachaiyappa’s College", lat: 13.0741, lon: 80.2326 }
      },
      "hi": {
        "1": { name: "हाई कोर्ट", lat: 13.08698, lon: 80.28763 },
        "2": { name: "एमजीआर सेंट्रल स्टेशन / सरकारी जनरल अस्पताल", lat: 13.0800, lon: 80.2767 },
        "3": { name: "पार्क स्टेशन", lat: 13.0805, lon: 80.2790 },
        "4": { name: "होटल एवरेस्ट", lat: 13.0810, lon: 80.2785 },
        "5": { name: "दिनाथंती", lat: 13.0820, lon: 80.2775 },
        "6": { name: "दासप्रकाश", lat: 13.0830, lon: 80.2765 },
        "7": { name: "संगम थिएटर", lat: 13.0840, lon: 80.2750 },
        "8": { name: "केएमसी अस्पताल", lat: 13.0850, lon: 80.2740 },
        "9": { name: "टेलर्स रोड", lat: 13.0860, lon: 80.2730 },
        "10": { name: "पचैयप्पा कॉलेज", lat: 13.0741, lon: 80.2326 }
      },
      "ta": {
        "1": { name: "ஹை கோர்ட்", lat: 13.08698, lon: 80.28763 },
        "2": { name: "எம்ஜிஆர் சென்ட்ரல் / அரசு பொது மருத்துவமனை", lat: 13.0800, lon: 80.2767 },
        "3": { name: "பார்க் ஸ்டேஷன்", lat: 13.0805, lon: 80.2790 },
        "4": { name: "ஹோட்டல் எவரெஸ்ட்", lat: 13.0810, lon: 80.2785 },
        "5": { name: "தினத்தந்தி", lat: 13.0820, lon: 80.2775 },
        "6": { name: "தாசப்ரகாஷ்", lat: 13.0830, lon: 80.2765 },
        "7": { name: "சங்கம் திரையரங்கம்", lat: 13.0840, lon: 80.2750 },
        "8": { name: "கே.எம்.சி மருத்துவமனை", lat: 13.0850, lon: 80.2740 },
        "9": { name: "டெய்லர்ஸ் சாலை", lat: 13.0860, lon: 80.2730 },
        "10": { name: "பச்சையப்பா கல்லூரி", lat: 13.0741, lon: 80.2326 }
      }
    };

    const langOptions = {
      "en": "Choose language:\n1. English\n2. Hindi\n3. Tamil",
      "hi": "भाषा चुनें:\n1. अंग्रेज़ी\n2. हिंदी\n3. तमिल",
      "ta": "மொழியை தேர்ந்தெடுக்கவும்:\n1. ஆங்கிலம்\n2. ஹிந்தி\n3. தமிழ்"
    };

    const stopOptions = {
      "en": "Choose stop:\n1. High Court\n2. MGR Central Station\n3. Park Station\n4. Hotel Everest\n5. Thinathanthi\n6. Dasaprakash\n7. Sangam Theatre\n8. KMC Hospital\n9. Taylors Road\n10. Pachaiyappa’s College",
      "hi": "बस स्टॉप चुनें:\n1. हाई कोर्ट\n2. एमजीआर सेंट्रल स्टेशन\n3. पार्क स्टेशन\n4. होटल एवरेस्ट\n5. दिनाथंती\n6. दासप्रकाश\n7. संगम थिएटर\n8. केएमसी अस्पताल\n9. टेलर्स रोड\n10. पचैयप्पा कॉलेज",
      "ta": "பஸ் நிறுத்தத்தை தேர்ந்தெடுக்கவும்:\n1. ஹை கோர்ட்\n2. எம்ஜிஆர் சென்ட்ரல்\n3. பார்க் ஸ்டேஷன்\n4. ஹோட்டல் எவரெஸ்ட்\n5. தினத்தந்தி\n6. தாசப்ரகாஷ்\n7. சங்கம் திரையரங்கம்\n8. கே.எம்.சி மருத்துவமனை\n9. டெய்லர்ஸ் சாலை\n10. பச்சையப்பா கல்லூரி"
    };

    function getDistance(lat1, lon1, lat2, lon2) {
      const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    async function getETA(stop) {
      const res = await fetch("http://localhost:5000/getBusLocation");
      const data = await res.json();
      if (data.latitude && data.longitude) {
        const dist = getDistance(data.latitude, data.longitude, stop.lat, stop.lon);
        const eta = Math.round((dist/30)*60);
        return `Bus ${data.driverId} → ${stop.name} in ~${eta} min(s)`;
      } else return "No active bus";
    }

    async function sendInput() {
      const val = document.getElementById("input").value.trim();
      document.getElementById("input").value = "";
      // Step 0: USSD code entry
      if (step === 0) {
        if (val === "*123#") {
          screen.innerText = langOptions["en"];
          step = 1;
        } else {
          screen.innerText = "Invalid code. Try *123#";
        }
      }
      // Step 1: Language selection
      else if (step === 1) {
        if (val === "1") { language = "en"; }
        else if (val === "2") { language = "hi"; }
        else if (val === "3") { language = "ta"; }
        else { screen.innerText = langOptions["en"] + "\nInvalid choice."; return; }
        screen.innerText = stopOptions[language];
        step = 2;
      }
      // Step 2: Bus stop selection
      else if (step === 2) {
        if (stops[language][val]) {
          screen.innerText = (language === "en") ? "Fetching ETA..." : (language === "hi") ? "ETA प्राप्त कर रहे हैं..." : "ETA பெறப்படுகிறது...";
          const msg = await getETA(stops[language][val]);
          screen.innerText = `${msg}\n\n0. Exit`;
          step = 3;
        } else {
          screen.innerText = stopOptions[language] + "\nInvalid choice.";
        }
      }
      // Step 3: Exit or invalid input
      else if (step === 3) {
        if (val === "0") {
          screen.innerText = (language === "en") ? "Session ended. Dial *123# to start again." :
            (language === "hi") ? "सत्र समाप्त हुआ। फिर से शुरू करने के लिए *123# डायल करें।" :
            "அமர்வு முடிந்தது. மீண்டும் தொடங்க *123# டயல் செய்யவும்.";
          step = 0;
        } else {
          screen.innerText += "\n\nInvalid input. Press 0 to Exit.";
        }
      }
    }
    // ...existing code...
  </script>
</body>
</html>