<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>USSD Simulator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body { display:flex; justify-content:center; align-items:center; height:100vh; background:#6cc5b3; font-family:'Segoe UI',monospace,Arial; }
    .phone { width:320px; height:540px; background:#c5edef; border-radius:24px; padding:14px; color:rgb(249,251,249); display:flex; flex-direction:column; box-shadow:0 8px 32px rgba(0,0,0,.18); }
    .header { color:#075a5a; text-align:center; margin-bottom:8px; font-size:1.1rem; font-weight:600; }
    .screen { background:#111; flex:1; padding:12px; border-radius:10px; overflow:auto; white-space:pre-line; font-size:1rem; }
    input,button { padding:10px; border-radius:8px; margin-top:8px; border:none; font-size:1rem; }
    input { background:#333; color:#c5edef; border:1px solid #444; width:93%; }
    button { background:#10929e; color:#fff; font-weight:700; cursor:pointer; transition:0.3s; }
    button:hover { background:#34495e; }
    @media(max-width:500px){ .phone{width:96vw;height:96vh} }
  </style>
</head>
<body>
  <div class="phone">
    <div class="header"><i class="fa-solid fa-mobile-screen-button"></i> USSD Simulator</div>
    <div id="screen" class="screen">Dial *123# to begin...</div>
    <input id="input" placeholder="Enter choice or *123#" />
    <button onclick="sendInput()"><i class="fa-solid fa-paper-plane"></i> Send</button>
  </div>

  <script>
    let step=0, language='en', lastStopKey=null, timeoutId=null;
    const screen=document.getElementById('screen'), inputEl=document.getElementById('input');

    const stops={
      en: {
        1:{name:"Chandigarh / General Bus Stand",lat:30.7333,lon:76.7794},
        2:{name:"Balongi",lat:30.7450,lon:76.8000},
        3:{name:"Kharar",lat:30.7219,lon:76.8032},
        4:{name:"Khanpur",lat:30.7412,lon:76.7845},
        5:{name:"Bhago Majra",lat:30.7523,lon:76.7976},
        6:{name:"Rurkee Pukhta",lat:30.7550,lon:76.7825},
        7:{name:"Mamupur",lat:30.7480,lon:76.7900},
        8:{name:"Gharuan",lat:30.7365,lon:76.7890},
        9:{name:"Marauli Kalan",lat:30.7420,lon:76.7950},
        10:{name:"Morinda",lat:30.7305,lon:76.7910}
      },
      hi: {
        1:{name:"चंडीगढ़ / जनरल बस स्टैंड",lat:30.7333,lon:76.7794},2:{name:"बालोंगी",lat:30.7450,lon:76.8000},3:{name:"खरार",lat:30.7219,lon:76.8032},4:{name:"खानपुर",lat:30.7412,lon:76.7845},5:{name:"भागो माजरा",lat:30.7523,lon:76.7976},6:{name:"रुर्की पुख्ता",lat:30.7550,lon:76.7825},7:{name:"मामुपुर",lat:30.7480,lon:76.7900},8:{name:"घरुआन",lat:30.7365,lon:76.7890},9:{name:"मराouli कलान",lat:30.7420,lon:76.7950},10:{name:"मोरिंडा",lat:30.7305,lon:76.7910}
      },
      ta: {
        1:{name:"சண்டிகர் / பொது பஸ் நிலையம்",lat:30.7333,lon:76.7794},2:{name:"பலோங்கி",lat:30.7450,lon:76.8000},3:{name:"காரர்",lat:30.7219,lon:76.8032},4:{name:"கான்பூர்",lat:30.7412,lon:76.7845},5:{name:"பாகோ மாஜ்ரா",lat:30.7523,lon:76.7976},6:{name:"ருர்கீ புக்‌தா",lat:30.7550,lon:76.7825},7:{name:"மாமுபூர்",lat:30.7480,lon:76.7900},8:{name:"காருவான்",lat:30.7365,lon:76.7890},9:{name:"மரௌலி கலான்",lat:30.7420,lon:76.7950},10:{name:"மொரிண்டா",lat:30.7305,lon:76.7910}
      },
      te: {
        1:{name:"చండీగఢ్ / జనరల్ బస్ స్టాండ్",lat:30.7333,lon:76.7794},2:{name:"బలోంగి",lat:30.7450,lon:76.8000},3:{name:"ఖరార్",lat:30.7219,lon:76.8032},4:{name:"ఖాన్‌పూర్",lat:30.7412,lon:76.7845},5:{name:"భాగో మాజ్రా",lat:30.7523,lon:76.7976},6:{name:"రుర్కీ పుఖ్తా",lat:30.7550,lon:76.7825},7:{name:"మాముపూర్",lat:30.7480,lon:76.7900},8:{name:"ఘరువాన్",lat:30.7365,lon:76.7890},9:{name:"మరౌలి కలాన్",lat:30.7420,lon:76.7950},10:{name:"మొరిండా",lat:30.7305,lon:76.7910}
      },
      ml: {
        1:{name:"ചണ്ഡിഗഡ് / ജനറല്‍ ബസ് സ്റ്റാന്‍ഡ്",lat:30.7333,lon:76.7794},2:{name:"ബലോംഗി",lat:30.7450,lon:76.8000},3:{name:"ഖരാര്‍",lat:30.7219,lon:76.8032},4:{name:"ഖാന്‍പൂര്‍",lat:30.7412,lon:76.7845},5:{name:"ഭാഗോ മാജ്ര",lat:30.7523,lon:76.7976},6:{name:"റുര്കീ പുഖ്ത",lat:30.7550,lon:76.7825},7:{name:"മാമുപൂര്‍",lat:30.7480,lon:76.7900},8:{name:"ഘരുവാന്‍",lat:30.7365,lon:76.7890},9:{name:"മരൗലി കലാന്‍",lat:30.7420,lon:76.7950},10:{name:"മൊറിണ്ട",lat:30.7305,lon:76.7910}
      }
    };

    const texts={
      en:{langPrompt:"Choose language:\n1. English\n2. Hindi\n3. Tamil\n4. Telugu\n5. Malayalam",
          stopPrompt:"Choose stop:\n1. Chandigarh\n2. Balongi\n3. Kharar\n4. Khanpur\n5. Bhago Majra\n6. Rurkee Pukhta\n7. Mamupur\n8. Gharuan\n9. Marauli Kalan\n10. Morinda",
          fetching:"Fetching ETA...", noBus:"No active bus. Please check later.", invalid:"Invalid choice.", sessionEnd:"Session ended. Dial *123# to start again.", optionsAfterETA:"\n\n1. Refresh ETA\n9. Back\n0. Exit"},
      hi:{langPrompt:"भाषा चुनें:\n1. अंग्रेज़ी\n2. हिंदी\n3. तमिल\n4. तेलुगु\n5. मलयालम",
          stopPrompt:"बस स्टॉप चुनें:\n1. चंडीगढ़\n2. बालोंगी\n3. खरार\n4. खानपुर\n5. भागो माजरा\n6. रुर्की पुख्ता\n7. मामुपुर\n8. घरुआन\n9. मराouli कलान\n10. मोरिंडा",
          fetching:"ETA प्राप्त कर रहे हैं...", noBus:"कोई बस सक्रिय नहीं है। कृपया बाद में जांचें।", invalid:"अमान्य चयन।", sessionEnd:"सत्र समाप्त हुआ। फिर से शुरू करने के लिए *123# डायल करें।", optionsAfterETA:"\n\n1. ETA रीफ़्रेश\n9. पीछे\n0. बाहर जाएँ"},
      ta:{langPrompt:"மொழியை தேர்ந்தெடுக்கவும்:\n1. ஆங்கிலம்\n2. ஹிந்தி\n3. தமிழ்\n4. தெலுங்கு\n5. மலையாளம்",
          stopPrompt:"பஸ் நிறுத்தத்தை தேர்ந்தெடுக்கவும்:\n1. சண்டிகர்\n2. பலோங்கி\n3. காரர்\n4. கான்பூர்\n5. பாகோ மாஜ்ரா\n6. ருர்கீ புக்‌தா\n7. மாமுபூர்\n8. காருவான்\n9. மரௌலி கலான்\n10. மொரிண்டா",
          fetching:"ETA பெறப்படுகிறது...", noBus:"இப்போது பேருந்து இயக்கத்தில் இல்லை. பிறகு முயற்சிக்கவும்.", invalid:"தவறான தேர்வு.", sessionEnd:"அமர்வு முடிந்தது. மீண்டும் தொடங்க *123# டயல் செய்யவும்.", optionsAfterETA:"\n\n1. ETA மறு பதிவேற்றம்\n9. பின்\n0. வெளியேறு"},
      te:{langPrompt:"భాషను ఎంచుకోండి:\n1. ఇంగ్లీష్\n2. హిందీ\n3. తమిళ్\n4. తెలుగు\n5. మలయాళం",
          stopPrompt:"బస్ స్టాప్ ఎంచుకోండి:\n1. చండీగఢ్\n2. బలోంగి\n3. ఖరార్\n4. ఖాన్‌పూర్\n5. భాగో మాజ్రా\n6. రుర్కీ పుఖ్తా\n7. మాముపూర్\n8. ఘరువాన్\n9. మరౌలి కలాన్\n10. మోరిండా",
          fetching:"ETA పొందబడుతోంది...", noBus:"ప్రస్తుతం బస్ లభ్యం కాదు. తర్వాత ప్రయత్నించండి.", invalid:"తప్పు ఎంపిక.", sessionEnd:"సెషన్ ముగిసింది. మళ్ళీ ప్రారంభించడానికి *123# డయల్ చేయండి.", optionsAfterETA:"\n\n1. ETA రిఫ్రెష్\n9. వెనక్కి\n0. బయటకు వెళ్లి"},
      ml:{langPrompt:"ഭാഷ തിരഞ്ഞെടുക്കുക:\n1. ഇംഗ്ലീഷ്\n2. ഹിന്ദി\n3. തമിഴ്\n4. തെലുങ്ക്\n5. മലയാളം",
          stopPrompt:"ബസ് സ്റ്റോപ്പ് തിരഞ്ഞെടുക്കുക:\n1. ചണ്ഡിഗഡ്\n2. ബലോംഗി\n3. ഖരാര്‍\n4. ഖാന്‍പൂര്‍\n5. ഭാഗോ മാജ്ര\n6. റുര്കീ പുഖ്ത\n7. മാമുപൂര്‍\n8. ഘരുവാന്‍\n9. മറൗലി കലാന്‍\n10. മൊറിണ്ട", fetching:"ETA ലഭിക്കുന്നു...", noBus:"ഇപ്പോൾ ബസ് പ്രവർത്തനത്തിൽ ഇല്ല. ദയവായി ശേഷം പരിശോധിക്കുക.", invalid:"തെറ്റായ തിരഞ്ഞെടുപ്പ്.", sessionEnd:"സെഷന്‍ അവസാനിച്ചു. വീണ്ടും തുടങ്ങ *123# ഡയൽ ചെയ്യുക.", optionsAfterETA:"\n\n1. ETA റിഫ്രഷ്\n9. പിന്\n0. പുറത്തുകടക്കുക"}
    };

    function getDistance(lat1,lon1,lat2,lon2){
      const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    function resetSession(){ step=0; language='en'; lastStopKey=null; clearTimeout(timeoutId); screen.innerText='Dial *123# to begin...'; }
    function startTimeout(){ clearTimeout(timeoutId); timeoutId=setTimeout(()=>{ resetSession(); },120000); }

    async function fetchETAForStop(stopObj){
      try{
        const res=await fetch('http://localhost:5000/getBusLocation');
        const data=await res.json();
        if(data && data.latitude && data.longitude){
          const dist=getDistance(data.latitude,data.longitude,stopObj.lat,stopObj.lon);
          const eta=Math.max(1, Math.round((dist/25)*60));
          return { ok:true, text:`${texts[language].fetching}\n${data.driverId || 'Bus'} → ${stopObj.name}\nETA: ~${eta} min(s)\nStatus: ${data.status || 'Unknown'}\nLast update: ${data.updatedAt?new Date(data.updatedAt).toLocaleString():'N/A'}` };
        } else return { ok:false, text:texts[language].noBus };
      } catch(err){ return { ok:false, text:'Error fetching location.'}; }
    }

    async function sendInput(){
      const val=inputEl.value.trim(); inputEl.value=''; startTimeout();
      if(step===0){ if(val==='*123#'){ screen.innerText=texts.en.langPrompt; step=1; return; } else { screen.innerText='Invalid code. Try *123#'; return; } }
      if(step===1){
        if(val==='1') language='en'; else if(val==='2') language='hi'; else if(val==='3') language='ta'; else if(val==='4') language='te'; else if(val==='5') language='ml'; else { screen.innerText=texts.en.langPrompt+'\n'+texts.en.invalid; return; }
        screen.innerText=texts[language].stopPrompt; step=2; return;
      }
      if(step===2){
        if(!stops[language][val]){ screen.innerText=texts[language].stopPrompt+'\n'+texts[language].invalid; return; }
        lastStopKey=val; screen.innerText=texts[language].fetching;
        const result=await fetchETAForStop(stops[language][val]);
        screen.innerText=result.ok?(result.text+texts[language].optionsAfterETA):result.text; step=3; return;
      }
      if(step===3){
        if(val==='1'){ if(!lastStopKey){ screen.innerText=texts[language].invalid; return; } screen.innerText=texts[language].fetching;
          const result=await fetchETAForStop(stops[language][lastStopKey]);
          screen.innerText=result.ok?(result.text+texts[language].optionsAfterETA):result.text; return;
        } else if(val==='9'){ screen.innerText=texts[language].stopPrompt; step=2; return; }
        else if(val==='0'){ screen.innerText=texts[language].sessionEnd; resetSession(); return; }
        else { screen.innerText=(screen.innerText||'')+'\n'+texts[language].invalid; return; }
      }
    }
    resetSession();
  </script>
</body>
</html>
