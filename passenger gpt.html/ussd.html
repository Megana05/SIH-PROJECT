<!-- ussd.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>USSD Simulator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body{display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,#2196F3 0%,#4CAF50 100%);font-family:'Segoe UI',monospace,Arial}
    .phone{width:320px;height:540px;background:#222;border-radius:24px;padding:14px;color:#0f0;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(44,62,80,.18)}
    .header{color:#fff;text-align:center;margin-bottom:8px;font-size:1.1rem}
    .screen{background:#111;flex:1;padding:12px;border-radius:10px;overflow:auto;white-space:pre-line;font-size:1rem}
    input,button{padding:10px;border-radius:8px;margin-top:8px;border:none;font-size:1rem}
    input{background:#333;color:#0f0;border:1px solid #444;width:93%}
    button{background:linear-gradient(90deg,#4CAF50 60%,#2196F3 100%);color:#fff;font-weight:700;cursor:pointer}
    @media(max-width:500px){.phone{width:96vw;height:96vh}}
  </style>
</head>
<body>
  <div class="phone">
    <div class="header"><i class="fa-solid fa-mobile-screen-button"></i> USSD Simulator</div>
    <div id="screen" class="screen">Dial *123# to begin...</div>
    <input id="input" placeholder="Enter choice or *123#" />
    <button onclick="sendInput()"><i class="fa-solid fa-paper-plane"></i> Send</button>
  </div>

  <script>
    // USSD improved flow with translations, back, refresh, timeout
    let step=0; let language='en'; let lastStopKey=null; let timeoutId=null;
    const screen=document.getElementById('screen');
    const inputEl=document.getElementById('input');

    const stops={
      en: {
        1:{name:"High Court",lat:13.08698,lon:80.28763},
        2:{name:"MGR Central Station / Govt. General Hospital",lat:13.0800,lon:80.2767},
        3:{name:"Park Station",lat:13.0805,lon:80.2790},
        4:{name:"Hotel Everest",lat:13.0810,lon:80.2785},
        5:{name:"Thinathanthi",lat:13.0820,lon:80.2775},
        6:{name:"Dasaprakash",lat:13.0830,lon:80.2765},
        7:{name:"Sangam Theatre",lat:13.0840,lon:80.2750},
        8:{name:"KMC Hospital",lat:13.0850,lon:80.2740},
        9:{name:"Taylors Road",lat:13.0860,lon:80.2730},
        10:{name:"Pachaiyappa’s College",lat:13.0741,lon:80.2326}
      },
      hi: { /* Hindi names */ 1:{name:"हाई कोर्ट",lat:13.08698,lon:80.28763},2:{name:"एमजीआर सेंट्रल स्टेशन / सरकारी जनरल अस्पताल",lat:13.0800,lon:80.2767},3:{name:"पार्क स्टेशन",lat:13.0805,lon:80.2790},4:{name:"होटल एवरेस्ट",lat:13.0810,lon:80.2785},5:{name:"दिनाथंती",lat:13.0820,lon:80.2775},6:{name:"दासप्रकाश",lat:13.0830,lon:80.2765},7:{name:"संगम थिएटर",lat:13.0840,lon:80.2750},8:{name:"केएमसी अस्पताल",lat:13.0850,lon:80.2740},9:{name:"टेलर्स रोड",lat:13.0860,lon:80.2730},10:{name:"पचैयप्पा कॉलेज",lat:13.0741,lon:80.2326}},
      ta: { /* Tamil names */ 1:{name:"ஹை கோர்ட்",lat:13.08698,lon:80.28763},2:{name:"எம்ஜிஆர் சென்ட்ரல் / அரசு பொது மருத்துவமனை",lat:13.0800,lon:80.2767},3:{name:"பார்க் ஸ்டேஷன்",lat:13.0805,lon:80.2790},4:{name:"ஹோட்டல் எவரெஸ்ட்",lat:13.0810,lon:80.2785},5:{name:"தினத்தந்தி",lat:13.0820,lon:80.2775},6:{name:"தாசப்ரகாஷ்",lat:13.0830,lon:80.2765},7:{name:"சங்கம் திரையரங்கம்",lat:13.0840,lon:80.2750},8:{name:"கே.எம்.சி மருத்துவமனை",lat:13.0850,lon:80.2740},9:{name:"டெய்லர்ஸ் சாலை",lat:13.0860,lon:80.2730},10:{name:"பச்சையப்பா கல்லூரி",lat:13.0741,lon:80.2326}}
    };

    const texts = {
      en: {
        langPrompt: "Choose language:\n1. English\n2. Hindi\n3. Tamil",
        stopPrompt: "Choose stop:\n1. High Court\n2. MGR Central Station\n3. Park Station\n4. Hotel Everest\n5. Thinathanthi\n6. Dasaprakash\n7. Sangam Theatre\n8. KMC Hospital\n9. Taylors Road\n10. Pachaiyappa’s College",
        fetching: "Fetching ETA...",
        noBus: "No active bus. Please check later.",
        invalid: "Invalid choice.",
        sessionEnd: "Session ended. Dial *123# to start again.",
        optionsAfterETA: "\n\n1. Refresh ETA\n9. Back\n0. Exit"
      },
      hi: {
        langPrompt: "भाषा चुनें:\n1. अंग्रेज़ी\n2. हिंदी\n3. तमिल",
        stopPrompt: "बस स्टॉप चुनें:\n1. हाई कोर्ट\n2. एमजीआर सेंट्रल स्टेशन\n3. पार्क स्टेशन\n4. होटल एवरेस्ट\n5. दिनाथंती\n6. दासप्रकाश\n7. संगम थिएटर\n8. केएमसी अस्पताल\n9. टेलर्स रोड\n10. पचैयप्पा कॉलेज",
        fetching: "ETA प्राप्त कर रहे हैं...",
        noBus: "कोई बस सक्रिय नहीं है। कृपया बाद में जांचें।",
        invalid: "अमान्य चयन।",
        sessionEnd: "सत्र समाप्त हुआ। फिर से शुरू करने के लिए *123# डायल करें।",
        optionsAfterETA: "\n\n1. ETA रीफ़्रेश\n9. पीछे\n0. बाहर जाएँ"
      },
      ta: {
        langPrompt: "மொழியை தேர்ந்தெடுக்கவும்:\n1. ஆங்கிலம்\n2. ஹிந்தி\n3. தமிழ்",
        stopPrompt: "பஸ் நிறுத்தத்தை தேர்ந்தெடுக்கவும்:\n1. ஹை கோர்ட்\n2. எம்ஜிஆர் சென்ட்ரல்\n3. பார்க் ஸ்டேஷன்\n4. ஹோட்டல் எவரெஸ்ட்\n5. தினத்தந்தி\n6. தாசப்ரகாஷ்\n7. சங்கம் திரையரங்கம்\n8. கே.எம்.சி மருத்துவமனை\n9. டெய்லர்ஸ் சாலை\n10. பச்சையப்பா கல்லூரி",
        fetching: "ETA பெறப்படுகிறது...",
        noBus: "இப்போது பேருந்து இயக்கத்தில் இல்லை. பிறகு முயற்சிக்கவும்.",
        invalid: "தவறான தேர்வு.",
        sessionEnd: "அமர்வு முடிந்தது. மீண்டும் தொடங்க *123# டயல் செய்யவும்.",
        optionsAfterETA: "\n\n1. ETA மறு பதிவேற்றம்\n9. பின்\n0. வெளியேறு"
      }
    };

    // helper distance
    function getDistance(lat1,lon1,lat2,lon2){
      const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    function resetSession(){
      step=0; language='en'; lastStopKey=null; clearTimeout(timeoutId);
      screen.innerText='Dial *123# to begin...';
    }

    function startTimeout(){
      clearTimeout(timeoutId);
      timeoutId=setTimeout(()=>{ resetSession(); }, 120000); // 2 minutes
    }

    async function fetchETAForStop(stopObj){
      try{
        const res=await fetch('http://localhost:5000/getBusLocation');
        const data=await res.json();
        if(data && data.latitude && data.longitude){
          const dist=getDistance(data.latitude,data.longitude,stopObj.lat,stopObj.lon);
          const eta=Math.max(1, Math.round((dist/25)*60)); // 25 km/h default
          return { ok:true, text: `${texts[language].fetching}\n${data.driverId || 'Bus'} → ${stopObj.name}\nETA: ~${eta} min(s)\nStatus: ${data.status || 'Unknown'}\nLast update: ${data.updatedAt ? new Date(data.updatedAt).toLocaleString() : 'N/A'}` };
        } else return { ok:false, text: texts[language].noBus };
      } catch(err){ return { ok:false, text: 'Error fetching location.' }; }
    }

    async function sendInput(){
      const val=document.getElementById('input').value.trim();
      document.getElementById('input').value='';
      startTimeout();

      // Step 0: expect code
      if(step===0){
        if(val==='*123#'){ screen.innerText=texts.en.langPrompt; // default english shown initially
          // show localized language selection prompts too
          setTimeout(()=>{ screen.innerText = texts.en.langPrompt; }, 50);
          step=1; return;
        } else { screen.innerText='Invalid code. Try *123#'; return; }
      }

      // Step 1: language selection
      if(step===1){
        if(val==='1') language='en';
        else if(val==='2') language='hi';
        else if(val==='3') language='ta';
        else { screen.innerText = texts.en.langPrompt + '\n' + texts.en.invalid; return; }
        screen.innerText = texts[language].stopPrompt;
        step=2; return;
      }

      // Step 2: stop selection
      if(step===2){
        if(!stops[language][val]){ screen.innerText = texts[language].stopPrompt + '\n' + texts[language].invalid; return; }
        lastStopKey=val;
        screen.innerText = texts[language].fetching;
        const result = await fetchETAForStop(stops[language][val]);
        screen.innerText = result.ok ? (result.text + texts[language].optionsAfterETA) : result.text;
        step=3; return;
      }

      // Step 3: after showing ETA -> options
      if(step===3){
        if(val==='1'){ // refresh ETA
          if(!lastStopKey){ screen.innerText = texts[language].invalid; return; }
          screen.innerText = texts[language].fetching;
          const result = await fetchETAForStop(stops[language][lastStopKey]);
          screen.innerText = result.ok ? (result.text + texts[language].optionsAfterETA) : result.text;
          return;
        } else if(val==='9'){ // back to stop list
          screen.innerText = texts[language].stopPrompt; step=2; return;
        } else if(val==='0'){ screen.innerText = texts[language].sessionEnd; resetSession(); return; }
        else { screen.innerText = (screen.innerText || '') + '\n' + texts[language].invalid; return; }
      }
    }

    // init
    resetSession();
  </script>
</body>
</html>
