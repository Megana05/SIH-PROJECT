<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Passenger Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      background:#6cc5b3;
      min-height:100vh;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card {
      background:#c5edef;
      border-radius:12px;
      padding:28px;
      width:400px;
      max-width:96vw;
      text-align:center;
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }
    h2 { color:#075a5a; margin:0 0 12px; }
    .info { background:#f5f5f5; padding:12px; border-radius:8px; text-align:left; margin-bottom:12px; }
    select,button { width:85%; padding:12px; margin:10px auto; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    button { border:none; background:#10929e; color:#fff; font-weight:700; cursor:pointer; transition:0.3s; }
    button:hover { background:#34495e; }
    #busStatus { min-height:70px; margin-top:10px; text-align:left; color:#075a5a; }
    iframe { width:100%; height:220px; border:0; border-radius:10px; margin-top:12px; display:none; }
    @media(max-width:500px){ .card{width:96vw;padding:18px} iframe{height:160px} }
  </style>
</head>
<body>
  <div class="card">
    <h2><i class="fa-solid fa-bus"></i> Passenger Page</h2>
    <div class="info">
      <strong>Track your bus in real time.</strong><br>
      Select your stop and tap below to get location, ETA, status and last update time.
    </div>
    <select id="stopSelect">
      <option value="">-- Choose your stop --</option>
      <option value="30.7333,76.7794">Chandigarh / General Bus Stand</option>
      <option value="30.7450,76.8000">Balongi</option>
      <option value="30.7219,76.8032">Kharar</option>
      <option value="30.7412,76.7845">Khanpur</option>
      <option value="30.7523,76.7976">Bhago Majra</option>
      <option value="30.7550,76.7825">Rurkee Pukhta</option>
      <option value="30.7480,76.7900">Mamupur</option>
      <option value="30.7365,76.7890">Gharuan</option>
      <option value="30.7420,76.7950">Marauli Kalan</option>
      <option value="30.7305,76.7910">Morinda</option>
    </select>
    <button onclick="getBusLocation()"><i class="fa-solid fa-location-dot"></i> Get Bus Location & ETA</button>
    <div id="busStatus"></div>
    <iframe id="mapFrame"></iframe>
  </div>

  <script>
    function getDistance(lat1, lon1, lat2, lon2){
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    function timeAgo(iso){
      if(!iso) return "Unknown";
      const diff=(Date.now() - new Date(iso).getTime())/1000;
      if(diff<60) return Math.round(diff)+" sec(s) ago";
      if(diff<3600) return Math.round(diff/60)+" min(s) ago";
      if(diff<86400) return Math.round(diff/3600)+" hour(s) ago";
      return Math.round(diff/86400)+" day(s) ago";
    }

    async function getBusLocation(){
      const stopVal=document.getElementById('stopSelect').value;
      const out=document.getElementById('busStatus');
      const map=document.getElementById('mapFrame');
      map.style.display='none';
      if(!stopVal){ out.innerText='Please select a stop.'; return; }
      out.innerText='Fetching bus location...';
      try{
        const res=await fetch('https://chalte-backend.onrender.com/getBusLocation');
        const data=await res.json();
        if(data && data.latitude && data.longitude){
          const [sLat,sLon]=stopVal.split(',').map(Number);
          const dist=getDistance(data.latitude,data.longitude,sLat,sLon);
          const eta=Math.max(1, Math.round((dist/25)*60));
          out.innerHTML = `<strong>Bus:</strong> ${data.driverId || 'N/A'}<br>
                           <strong>Status:</strong> ${data.status || 'Unknown'}<br>
                           <strong>ETA to stop:</strong> ${eta} min(s)<br>
                           <strong>Last update:</strong> ${timeAgo(data.updatedAt)}`;
          const mapUrl=`https://maps.google.com/maps?q=${data.latitude},${data.longitude}&z=15&output=embed`;
          map.src=mapUrl; map.style.display='block';
        } else { out.innerText='No active bus location available. Please check later.'; }
      } catch(err){ out.innerText='Error fetching location.'; }
    }
  </script>
</body>
</html>
